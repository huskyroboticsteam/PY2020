#include "CameraParams.h"

#include <opencv2/core.hpp>

namespace cam
{

////////////// CONSTRUCTORS //////////////

CameraParams::CameraParams()
{
}

void CameraParams::init(const cv::Mat &camera_matrix, const cv::Mat &dist_coeff,
						cv::Size image_size)
{
	if (camera_matrix.size() != cv::Size(3, 3))
	{
		throw std::invalid_argument("Camera matrix must be 3x3");
	}
	int n_coeffs = dist_coeff.rows * dist_coeff.cols;
	if (!(n_coeffs == 4 || n_coeffs == 5 || n_coeffs == 8 || n_coeffs == 12 || n_coeffs == 14))
	{
		throw std::invalid_argument(
			"Number of distortion coefficients must be 4, 5, 8, 12, or 14");
	}
	if (image_size.empty())
	{
		throw std::invalid_argument("Image size must not be empty");
	}

	dist_coeff.reshape(1, {n_coeffs, 1}).copyTo(this->_dist_coeff);
	camera_matrix.copyTo(this->_camera_matrix);
	this->_image_size = image_size;
}

CameraParams::CameraParams(const cv::Mat &camera_matrix, const cv::Mat &dist_coeff,
						   cv::Size image_size)
{
	init(camera_matrix, dist_coeff, image_size);
}

CameraParams::CameraParams(const CameraParams &other)
{
	cv::Mat newCam, newDist;
	other._camera_matrix.copyTo(newCam);
	other._dist_coeff.copyTo(newDist);
	this->_camera_matrix = newCam;
	this->_dist_coeff = newDist;

	this->_image_size = other._image_size;
}

bool CameraParams::empty() const
{
	return _camera_matrix.empty() || _dist_coeff.empty() || _image_size.empty();
}

////////////// ACCESSORS /////////////////

cv::Mat CameraParams::getCameraMatrix() const
{
	return _camera_matrix;
}

cv::Mat CameraParams::getDistCoeff() const
{
	return _dist_coeff;
}

cv::Size CameraParams::getImageSize() const
{
	return _image_size;
}

////////////// SERIALIZATION //////////////

void CameraParams::readFromFileNode(const cv::FileNode &file_node)
{
	cv::Mat cam, dist;
	file_node[KEY_CAMERA_MATRIX] >> cam;
	file_node[KEY_DIST_COEFFS] >> dist;
	int w, h;
	w = (int)file_node[KEY_IMAGE_WIDTH];
	h = (int)file_node[KEY_IMAGE_HEIGHT];
	cv::Size size(w, h);
	// call init to do validation
	init(cam, dist, size);
}

void CameraParams::writeToFileStorage(cv::FileStorage &file_storage) const
{
	file_storage << "{";
	file_storage << KEY_IMAGE_WIDTH << _image_size.width;
	file_storage << KEY_IMAGE_HEIGHT << _image_size.height;
	file_storage << KEY_CAMERA_MATRIX << _camera_matrix;
	file_storage << KEY_DIST_COEFFS << _dist_coeff;
	file_storage << "}";
}

void read(const cv::FileNode &node, CameraParams &params, const CameraParams &default_value)
{
	if (node.empty())
	{
		params = default_value;
	}
	else
	{
		params.readFromFileNode(node);
	}
}

void write(cv::FileStorage &fs, const std::string &name, const CameraParams &params)
{
	params.writeToFileStorage(fs);
}

// TODO: These all need to be moved into .yml files
/*
 * Below are all the parameters for various cameras that we have calibrated. Please do not
 * change any of these numbers, as they are automatically generated by the calibration program
 * and the program may not work as intended if they are changed.
 */

// clang-format off
// -------------------------------------
// Evan's old webcam, 640x480, scale in mm
// -------------------------------------
constexpr double _webcam_params[] = {5.5929841506515140e+02, 0., 3.3632998221165434e+02,
									0.,5.5929841506515140e+02, 2.4560280586167062e+02,
									0., 0., 1.};
constexpr double _webcam_dist[] = {2.2319725483552814e-02, -2.3138101190867111e-01,
								  3.6220766734074462e-03, 3.8852893952725500e-03,
								  5.4773015987500950e-01};

const CameraParams WEBCAM_PARAMS(cv::Mat(3, 3, CV_64F, *_webcam_params),
								 cv::Mat(5, 1, CV_64F, *_webcam_dist));
// -------------------------------------


// -------------------------------------
// Evan's Laptop webcam, 640x480, scale in mm
// -------------------------------------
constexpr double _laptop_params[] = {5.6534586568739849e+02, 0., 3.5588060437029822e+02,
									0.,5.6534586568739849e+02, 2.9541081641775287e+02,
									0., 0., 1.};
constexpr double _laptop_dist[] = {3.4425270669197583e-01, -4.5627505509852968e+00,
								  1.4729564760154447e-04, -1.2416402052553264e-02,
								  1.5720190712074883e+01};

const CameraParams LAPTOP_PARAMS(cv::Mat(3, 3, CV_64F, *_laptop_params),
								 cv::Mat(5, 1, CV_64F, *_laptop_dist));
// -------------------------------------


// -------------------------------------
// Evan's old webcam, 1280x720, scale in m
// -------------------------------------
constexpr double _webcam_720_params[] = {9.3961383346628031e+02, 0., 6.3484000394178668e+02,
										 0., 9.3961383346628031e+02, 3.7840207513366113e+02,
										 0., 0., 1.};
constexpr double _webcam_720_dist[] = {2.1134874734267596e-02, -3.1838385257944879e-01,
									   7.2249055307435119e-03, -9.2194715382554367e-03,
									   6.5454969448093581e-01};

const CameraParams WEBCAM_720_PARAMS(cv::Mat(3, 3, CV_64F, *_webcam_720_params),
									 cv::Mat(5, 1, CV_64F, *_webcam_720_dist));

// -------------------------------------


// -------------------------------------
// Evan's old webcam, 1920x1080, scale in m
// -------------------------------------
constexpr double _webcam_1080_params[] = {1.6344311125816394e+03, 0., 9.7545425956890222e+02,
										 0.,1.6344311125816394e+03, 6.4209372992259819e+02,
										 0., 0., 1.};
constexpr double _webcam_1080_dist[] = {-2.1266729721561975e-02, -3.1767566462011504e-01,
									   1.9258722839178691e-02, -3.7013946009933673e-03,
									   7.9803079689451806e-01};

const CameraParams WEBCAM_1080_PARAMS(cv::Mat(3, 3, CV_64F, *_webcam_1080_params),
									  cv::Mat(5, 1, CV_64F, *_webcam_1080_dist));
// -------------------------------------


// -------------------------------------
// Winston's Webcam, 640x480, scale in m
// -------------------------------------
constexpr double _winston_webcam_480_params[] = {6.2703337187188697e+02, 0., 3.2677375666624550e+02,
 												0., 6.2703337187188697e+02, 2.3701509360183852e+02, 
												0., 0., 1.};
constexpr double _winston_webcam_480_dist[] = {8.7938715033125687e-03, 1.6438593467138751e-01,
       										  1.9323488037337649e-04, -3.7075323762211791e-03,
       										  -1.1096023248348679e+00};

const CameraParams WINSTON_WEBCAM_480_PARAMS(cv::Mat(3, 3, CV_64F, *_winston_webcam_480_params),
											 cv::Mat(5, 1, CV_64F, *_winston_webcam_480_dist));
// -------------------------------------

// --------------------------------------
// Evan's new webcam, 640x480, scale in m
// --------------------------------------
constexpr double _evan_new_webcam_480_params[] = {6.5178996279573414e+02, 0., 3.4239207757066441e+02,
	                                              0., 6.6309428622755718e+02, 2.2945775282381234e+02,
	                                              0., 0., 1.};
constexpr double _evan_new_webcam_480_dist[] = {-3.6842153449902861e-03, -8.3861698098247113e-05,
												-7.1088419024984209e-03, -4.1784556258417084e-04,
												3.0386330418980679e-07};

const CameraParams EVAN_NEW_WEBCAM_480_PARAMS(cv::Mat(3, 3, CV_64F, *_evan_new_webcam_480_params),
											 cv::Mat(5, 1, CV_64F, *_evan_new_webcam_480_dist));
// -------------------------------------
// --------------------------------------
// Robot top webcamera, 640x480, scale in m
// --------------------------------------
constexpr double _robot_top_webcam_480_params[] = {6.4140478114760754e+02, 0., 3.3489433405024562e+02, 
												0., 6.4140478114760754e+02, 2.4549088452431096e+02, 
												0.,0., 1.};
constexpr double _robot_top_webcam_480_dist[] = {-4.5423809818390071e-01, 3.2556375646404534e-01,
       											6.0432508258992704e-04, -1.1136436683798529e-03,
       											-2.5321322863141504e-01};

const CameraParams ROBOT_TOP_WEBCAM_480_PARAMS(cv::Mat(3, 3, CV_64F, *_robot_top_webcam_480_params),
											 cv::Mat(5, 1, CV_64F, *_robot_top_webcam_480_dist));
// clang-format on
// -------------------------------------

CameraParams getCameraParams(Params params)
{
	switch (params)
	{
	case WINSTON_WEBCAM_480:
		return WINSTON_WEBCAM_480_PARAMS;
	case WEBCAM_1080:
		return WEBCAM_1080_PARAMS;
	case WEBCAM_720:
		return WEBCAM_720_PARAMS;
	case LAPTOP:
		return LAPTOP_PARAMS;
	case WEBCAM:
		return WEBCAM_PARAMS;
	case EVAN_NEW_WEBCAM_480:
		return EVAN_NEW_WEBCAM_480_PARAMS;
	case ROBOT_TOP_WEBCAM_480:
		return ROBOT_TOP_WEBCAM_480_PARAMS;
	}
}

} // namespace cam
